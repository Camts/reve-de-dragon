service.dao = {
	initialPersoData : {
		id : {
			nom : "",
			hautRevant : true,
			sexe : "M",
			age : 20,
			heure : 1,
			taille : "1m70",
			poids : undefined,
			cheveux : "",
			yeux : "",
			signePart : ""
		},
		carac : {
			taille : {
				val : 6
			},
			apparence : {
				val : 6,
				xp : undefined
			},
			constitution : {
				val : 6,
				xp : undefined
			},
			force : {
				val : 6,
				xp : undefined
			},
			agilite : {
				val : 6,
				xp : undefined
			},
			dexterite : {
				val : 6,
				xp : undefined
			},
			vue : {
				val : 6,
				xp : undefined
			},
			ouie : {
				val : 6,
				xp : undefined
			},
			odorat : {
				val : 6,
				xp : undefined
			},
			gout : {
				val : 6,
				xp : undefined
			},
			volonte : {
				val : 6,
				xp : undefined
			},
			intellect : {
				val : 6,
				xp : undefined
			},
			empathie : {
				val : 6,
				xp : undefined
			},
			eloquence : {
				val : 6,
				xp : undefined
			},
			reve : {
				val : 6,
				xp : undefined
			},
			chance : {
				val : 6,
				xp : undefined
			}
		},
		comp : {
			/* Générales */
			chant : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			danse : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			discours : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			discretion : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			escalade : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			esquive : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			saut : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			seCacher : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			course : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			srvExt : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			dessin : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			cuisine : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			bricolage : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			seduction : {
				type : "gen",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			/* Combat */
			epee1m : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			epee2m : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			hache1m : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			hache2m : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			masse1m : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			masse2m : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			fleaux : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			dague : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			corpsACorps : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			bouclier : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			arc : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			arbalete : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			dagueLancee : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			hacheLancee : {
				type : "combat",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			/* Particulières */
			charpenterie : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			comedie : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			commerce : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			equitation : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			maconnerie : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			musique : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			pickpocket : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			premiersSoins : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			srvCite : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			srvMer : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			srvDesert : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			srvForet : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			srvGlace : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			srvMarais : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			srvMontagne : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			srvPlaine : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			srvSousSol : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			travestissement : {
				type : "part",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			/* Spéciales */
			acrobatie : {
				type : "spe",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			armurerie : {
				type : "spe",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			jeu : {
				type : "spe",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			jonglerie : {
				type : "spe",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			maroquinerie : {
				type : "spe",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			natation : {
				type : "spe",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			navigation : {
				type : "spe",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			orfevrerie : {
				type : "spe",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			serrurerie : {
				type : "spe",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			/* Connaissances */
			alchimie : {
				type : "conn",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			astrologie : {
				type : "conn",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			botanique : {
				type : "conn",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			chirurgie : {
				type : "conn",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			legendes : {
				type : "conn",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			lireEtEcrire : {
				type : "conn",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			medecine : {
				type : "conn",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			zoologie : {
				type : "conn",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			/* Draconic */
			oniros : {
				type : "drac",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			hypnos : {
				type : "drac",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			narcos : {
				type : "drac",
				val : undefined,
				arch : 0,
				xp : undefined
			},
			thanatos : {
				type : "drac",
				val : undefined,
				arch : 0,
				xp : undefined
			}
		},
		magie : {
			terreMediane : "G7",
			monte : false,
			sorts : [/*
						 * { voie : "hypnos", nom : "Abc", typeCase : "PLAINES",
						 * diff : -1, conso : 1, portee : undefined, variable :
						 * true, rituel : false, bonus : { G8 : 12, I7 : 5 },
						 * detail : "Détail abc" }
						 */],
			reserve : {/* G8 : "Abc" */}
		},
		compteur : {
			date : {
				heure : 1,
				jour : 1,
				mois : 1,
				annee : 1
			},
			destinee : 6,
			moral : 0,
			xpEndu : undefined,
			reve : 6,
			stress : undefined,
			perteVieHorsBlessure : undefined,
			perteEnduHorsBlessure : undefined,
			fatigue : 0
		},
		combat : {
			diff : {
				att : 0,
				dist : 0,
				def : 0
			},
			round : undefined,
			sonne : undefined
		},
		blessure : [/*
					 * { grade: 17, type : "T", localisation : "thorax", jours :
					 * 1, heure : 10, endu : 5, vie : 1, saigne : false, herbes : {
					 * heure : 11, qualite : 4, bruns : 6 }, recupEndu : false,
					 * soin : undefined }
					 */],
		eqmt : { /* equipement */
			monnaie : {
				etain : 0,
				bronze : 0,
				argent : 0,
				or : 0
			},
			herbe : {
				soin : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
				lune : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
			},
			arme : {/* comp : {nom:, bonus:, dt:, dc:, dp:, res:, enc:} */},
			armure : {
				hancheArme : {
					val : 0,
					bonus : 0
				},
				crane : {
					val : 0,
					bonus : 0
				},
				hancheBouclier : {
					val : 0,
					bonus : 0
				},
				cuisseArme : {
					val : 0,
					bonus : 0
				},
				visage : {
					val : 0,
					bonus : 0
				},
				cuisseBouclier : {
					val : 0,
					bonus : 0
				},
				genouxArme : {
					val : 0,
					bonus : 0
				},
				cou : {
					val : 0,
					bonus : 0
				},
				genouxBouclier : {
					val : 0,
					bonus : 0
				},
				epauleArme : {
					val : 0,
					bonus : 0
				},
				thorax : {
					val : 0,
					bonus : 0
				},
				epauleBouclier : {
					val : 0,
					bonus : 0
				},
				brasArme : {
					val : 0,
					bonus : 0
				},
				cotesArme : {
					val : 0,
					bonus : 0
				},
				brasBouclier : {
					val : 0,
					bonus : 0
				},
				coudeArme : {
					val : 0,
					bonus : 0
				},
				ventre : {
					val : 0,
					bonus : 0
				},
				coudeBouclier : {
					val : 0,
					bonus : 0
				},
				avantBrasArme : {
					val : 0,
					bonus : 0
				},
				cotesBouclier : {
					val : 0,
					bonus : 0
				},
				avantBrasBouclier : {
					val : 0,
					bonus : 0
				},
				poignetArme : {
					val : 0,
					bonus : 0
				},
				basVentre : {
					val : 0,
					bonus : 0
				},
				poignetBouclier : {
					val : 0,
					bonus : 0
				},
				mainArme : {
					val : 0,
					bonus : 0
				},
				mainBouclier : {
					val : 0,
					bonus : 0
				}
			},
			sac : [{
				nom : "Ceinture",
				liste : [/* {nom:, qte:}, {nom:, qte:} */]
			}, {
				nom : "Besace",
				liste : []
			}, {
				nom : "Grand sac",
				liste : []
			}, {
				nom : "Monture",
				liste : []
			}]
		}
	},

	initialPersoDisplay : {
		pref : {
			background : 0,
			zones : false,
			archetype : false,
			compMin : -11,
			compToutes : false
		},
		cadre : {
			jet : "h",
			compToutesCols : 5,
			identite : {
				heure : "bottom"
			},
			combat : {
				eqmt : false
			},
			encaissement : {
				armure : false
			},
			blessures : {
				detail : false,
				heure : "middle"
			},
			magieSort : {
				actions : true
			}
		},
		sac : [["Ceinture", "Besace"], ["Grand sac"], ["Monture"]]
	},

	initialPersoZones : {
		normal : [[
				[
						["cadre-identite", "cadre-jet"],
						[
								"cadre-caracs",
								[[[["cadre-attributs"], ["cadre-vie"]], "cadre-date"],
										[["cadre-fatigue", "cadre-monnaie"], "cadre-endurance"]]], ["cadre-sacs"]],
				[
						["cadre-comp-toutes", [["cadre-comp-gen"], ["cadre-comp-drac"]], "cadre-comp-combat",
								"cadre-comp-part", [["cadre-comp-spe"], ["cadre-comp-conn"]]],
						[[["cadre-herbes", [["cadre-compteurs"], ["cadre-round"]]], ["cadre-encaissement"]],
								"cadre-combat"], ["cadre-blessures"]]]],
		magie : [["cadre-magie-terres-medianes",
				[["cadre-magie-drac", "cadre-magie-compteurs", "cadre-magie-rencontre"], ["cadre-magie-sorts"]]]]
	},

	initialPnjData : {
		persos : [],
		modeles : []
	},

	initialPnjDisplay : {
		pref : {
			background : 0,
			zones : false,
			archetype : false,
			compMin : -11,
			compToutes : false
		},
		cadre : {
			jet : "h",
			compToutesCols : 5,
			identite : {
				heure : "bottom"
			},
			combat : {
				eqmt : true
			},
			encaissement : {
				armure : true
			},
			blessures : {
				detail : true,
				heure : "middle"
			}
		},
		sac : [["Ceinture", "Besace"], ["Grand sac"], ["Monture"]]
	},

	initialPersoZones : [[
			[
					["cadre-identite", "cadre-jet"],
					[
							"cadre-caracs",
							[[[["cadre-attributs"], ["cadre-vie"]], "cadre-date"], ["cadre-fatigue", "cadre-endurance"]]]],
			[
					["cadre-comp-toutes", [["cadre-comp-gen"], ["cadre-comp-drac"]], "cadre-comp-combat",
							"cadre-comp-part", [["cadre-comp-spe"], ["cadre-comp-conn"]]],
					[[["cadre-compteurs"], ["cadre-round"], ["cadre-encaissement"]], "cadre-combat"],
					["cadre-blessures"]]]],

	fs : undefined,
	dataDir : undefined,

	loadPerso : function() {
		var perso, display, zones;
		if (service.dao.fs != undefined) {
			if (!service.dao.fs.existsSync(service.dao.dataDir))
				service.dao.fs.mkdirSync(service.dao.dataDir);

			if (service.dao.fs.existsSync(service.dao.dataDir + "/perso.json")) {
				perso = JSON.parse(service.dao.fs.readFileSync(service.dao.dataDir + "/perso.json"));
				service.dao.merge("perso", perso, service.dao.initialPersoData);
			} else
				perso = service.dao.initialPersoData;

			if (service.dao.fs.existsSync(service.dao.dataDir + "/display.json")) {
				display = JSON.parse(service.dao.fs.readFileSync(service.dao.dataDir + "/display.json"));
				service.dao.merge("display", display, service.dao.initialPersoDisplay);
			} else
				display = service.dao.initialPersoDisplay;

			if (service.dao.fs.existsSync(service.dao.dataDir + "/zones.json"))
				zones = JSON.parse(service.dao.fs.readFileSync(service.dao.dataDir + "/zones.json"));
			else
				zones = service.dao.initialPersoZones;
		} else {
			perso = service.dao.initialPersoData;
			display = service.dao.initialPersoDisplay;
			zones = service.dao.initialPersoZones;
		}

		service.dao.data = {
			perso : perso,
			display : display,
			zones : zones,
		};

		return service.dao.data;
	},

	loadPNJs : function() {
		var pnjs, display, zones;
		if (service.dao.fs != undefined) {
			if (!service.dao.fs.existsSync(service.dao.dataDir))
				service.dao.fs.mkdirSync(service.dao.dataDir);

			if (service.dao.fs.existsSync(service.dao.dataDir + "/pnj-persos.json")) {
				pnjs = JSON.parse(service.dao.fs.readFileSync(service.dao.dataDir + "/pnj-persos.json"));
				service.dao.merge("perso", perso, service.dao.initialPnjData);
			} else
				pnjs = service.dao.initialPnjData;

			if (service.dao.fs.existsSync(service.dao.dataDir + "/pnj-display.json")) {
				display = JSON.parse(service.dao.fs.readFileSync(service.dao.dataDir + "/pnj-display.json"));
				service.dao.merge("display", display, service.dao.initialPnjDisplay);
			} else
				display = service.dao.initialPnjDisplay;

			if (service.dao.fs.existsSync(service.dao.dataDir + "/pnj-zones.json"))
				zones = JSON.parse(service.dao.fs.readFileSync(service.dao.dataDir + "/pnj-zones.json"));
			else
				zones = service.dao.initialPnjZones;
		} else {
			pnjs = service.dao.initialPnjData;
			display = service.dao.initialPnjDisplay;
			zones = service.dao.initialPnjZones;
		}

		service.dao.data = {
			pnjs : pnjs,
			display : display,
			zones : zones,
		};

		return service.dao.data;
	},

	save : function() {
		if (service.dao.fs != undefined) {
			var perso = service.dao.data.perso;
			service.dao.removeHashKeys(perso);
			service.dao.fs.writeFileSync(service.dao.dataDir + "/perso.json", JSON.stringify(perso));

			service.dao.displayVerifySacs();
			var display = service.dao.data.display;
			service.dao.removeHashKeys(display);
			service.dao.fs.writeFileSync(service.dao.dataDir + "/display.json", JSON.stringify(display));

			service.dao.fs.writeFileSync(service.dao.dataDir + "/zones.json", JSON.stringify({
				normal : zone.getConfig("cadres-normal"),
				magie : zone.getConfig("cadres-magie")
			}));
		}
	},

	merge : function(path, data, from) {
		if (from instanceof Array) {
			var i = 0;
			while (i < data.length) {
				if (from[i] instanceof Object)
					service.dao.merge(path + "[" + i + "]", data[i], from[i])
				i++;
			}
			while (i < from.length) {
				util.notify("Merge : add " + path + "[" + i + "]");
				data.push(from[i]);
				i++;
			}
		} else if (from instanceof Object) {
			for ( var attr in from)
				if (from[attr] !== undefined)
					if (data[attr] !== undefined) {
						if (from[attr] instanceof Object)
							service.dao.merge(path + "." + attr, data[attr], from[attr]);
					} else {
						util.notify("Merge : add " + path + "." + attr);
						data[attr] = from[attr];
					}
		}
	},

	removeHashKeys : function(data) {
		if (data instanceof Array) {
			for (var i = 0; i < data.length; i++)
				if (data[i] instanceof Object)
					service.dao.removeHashKeys(data[i])
		} else if (data instanceof Object)
			for ( var attr in data)
				if (attr == "$$hashKey")
					data[attr] = undefined;
				else if (data[attr] instanceof Object)
					service.dao.removeHashKeys(data[attr]);
	},

	displayVerifySacs : function() {
		var display = service.dao.data.display.sac;
		var sacs = service.dao.data.perso.eqmt.sac;
		var i, j, col, nom, noms = {};
		for (i = 0; i < sacs.length; i++)
			noms[sacs[i].nom] = false;
		i = 0;
		while (i < display.length) {
			j = 0;
			while (j < display[i].length) {
				nom = display[i][j];
				if (noms[nom]) {
					display[i].splice(j, 1);
				} else {
					noms[nom] = true;
					j++;
				}
			}
			if (display[i].length == 0)
				display.splice(i, 1);
			else
				i++;
		}
		util.notify("3)");
		for (nom in noms) {
			if (!noms[nom])
				display.push([nom]);
		}
	}
};

// Initialisation
if (typeof (require) != "undefined") {
	service.dao.fs = require("fs");
	service.dao.dataDir = process.env.APPDATA + "/reve-de-dragon";

	var gui = require('nw.gui');
	if (gui) {
		var win = gui.Window.get();
		win.on('close', function() {
			service.dao.save();
			gui.App.quit();
		});
	}
}